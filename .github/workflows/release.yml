name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Run tests across platforms before releasing
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python: ["3.10", "3.11", "3.12"]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install lucidscan
        run: pip install -e .

      - name: Run tests
        run: |
          pip install pytest pytest-asyncio
          pytest tests/ -v

  # Build and publish Python package to PyPI
  publish-pypi:
    needs: [test]
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  # Build and push Docker image with pre-downloaded scanner binaries
  build-docker:
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read tool versions
        id: versions
        run: |
          echo "trivy=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['tools']['trivy'])")" >> $GITHUB_OUTPUT
          echo "opengrep=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['tools']['opengrep'])")" >> $GITHUB_OUTPUT
          echo "checkov=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['tools']['checkov'])")" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Dockerfile
        run: |
          cat > Dockerfile <<EOF
          FROM python:3.11-slim

          # Install system dependencies
          RUN apt-get update && apt-get install -y curl unzip git && rm -rf /var/lib/apt/lists/*

          # Create lucidscan directories
          RUN mkdir -p /root/.lucidscan/bin/trivy/${{ steps.versions.outputs.trivy }} \
                       /root/.lucidscan/bin/opengrep/${{ steps.versions.outputs.opengrep }} \
                       /root/.lucidscan/bin/checkov/${{ steps.versions.outputs.checkov }} \
                       /root/.lucidscan/cache/trivy

          # Pre-download Trivy binary
          RUN curl -sfL "https://github.com/aquasecurity/trivy/releases/download/v${{ steps.versions.outputs.trivy }}/trivy_${{ steps.versions.outputs.trivy }}_Linux-64bit.tar.gz" \
              | tar xzf - -C /root/.lucidscan/bin/trivy/${{ steps.versions.outputs.trivy }} \
              && chmod +x /root/.lucidscan/bin/trivy/${{ steps.versions.outputs.trivy }}/trivy

          # Pre-download OpenGrep binary (standalone binary for glibc-based Linux)
          RUN curl -sfL "https://github.com/opengrep/opengrep/releases/download/v${{ steps.versions.outputs.opengrep }}/opengrep_manylinux_x86" \
              -o /root/.lucidscan/bin/opengrep/${{ steps.versions.outputs.opengrep }}/opengrep \
              && chmod +x /root/.lucidscan/bin/opengrep/${{ steps.versions.outputs.opengrep }}/opengrep

          # Pre-install Checkov in a venv
          RUN python -m venv /root/.lucidscan/bin/checkov/${{ steps.versions.outputs.checkov }}/venv \
              && /root/.lucidscan/bin/checkov/${{ steps.versions.outputs.checkov }}/venv/bin/pip install --upgrade pip \
              && /root/.lucidscan/bin/checkov/${{ steps.versions.outputs.checkov }}/venv/bin/pip install "checkov==${{ steps.versions.outputs.checkov }}"

          # Pre-warm Trivy vulnerability database
          RUN /root/.lucidscan/bin/trivy/${{ steps.versions.outputs.trivy }}/trivy image --download-db-only --cache-dir /root/.lucidscan/cache/trivy 2>/dev/null || true

          # Install lucidscan CLI framework (will use pre-downloaded binaries)
          RUN pip install --no-cache-dir lucidscan || echo "lucidscan not yet on PyPI, skipping"

          WORKDIR /workspace
          ENTRYPOINT ["lucidscan"]
          EOF

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/lucidscan:latest
            ghcr.io/${{ github.repository_owner }}/lucidscan:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Create GitHub Release
  create-release:
    needs: [publish-pypi, build-docker]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read versions for release notes
        id: versions
        run: |
          echo "trivy=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['tools']['trivy'])")" >> $GITHUB_OUTPUT
          echo "opengrep=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['tools']['opengrep'])")" >> $GITHUB_OUTPUT
          echo "checkov=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['tools']['checkov'])")" >> $GITHUB_OUTPUT
          echo "lucidscan=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## LucidScan - The Trust Layer for AI-Assisted Development

            LucidScan unifies code quality tools (linting, type checking, security, testing, coverage) into a single pipeline that auto-configures for any project and integrates with AI coding tools like Claude Code and Cursor.

            ## Installation

            ```bash
            pip install lucidscan
            ```

            On first run, plugins automatically download their binaries for your platform.

            ## Docker Image (Recommended for CI)

            ```bash
            docker pull ghcr.io/voldeq/lucidscan:${{ steps.versions.outputs.lucidscan }}
            ```

            The Docker image includes pre-downloaded scanner binaries and a pre-warmed Trivy vulnerability database for instant scanning.

            ## Features

            - **Security Scanning**: Trivy (SCA), OpenGrep (SAST), Checkov (IaC)
            - **Linting**: Ruff, ESLint, Biome, Checkstyle
            - **Type Checking**: mypy, pyright, TypeScript
            - **Testing**: pytest, Jest
            - **Coverage**: coverage.py, Istanbul
            - **AI Integration**: MCP server for Claude Code and Cursor

            ## Quick Start

            ```bash
            # Initialize project
            lucidscan init

            # Run all checks
            lucidscan scan --all

            # Run specific domains
            lucidscan scan --lint --type-check --test --coverage

            # Auto-fix linting issues
            lucidscan scan --lint --fix

            # MCP server for AI tools
            lucidscan serve --mcp

            # File watcher mode
            lucidscan serve --watch
            ```

            ## AI Tool Integration

            Add to your Claude Code or Cursor MCP configuration:

            ```json
            {
              "mcpServers": {
                "lucidscan": {
                  "command": "lucidscan",
                  "args": ["serve", "--mcp"]
                }
              }
            }
            ```

            ## Default Scanner Plugin Versions

            | Scanner Plugin | Version |
            |----------------|---------|
            | Trivy | ${{ steps.versions.outputs.trivy }} |
            | OpenGrep | ${{ steps.versions.outputs.opengrep }} |
            | Checkov | ${{ steps.versions.outputs.checkov }} |
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
