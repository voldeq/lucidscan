name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Build platform-specific bundles
  build-bundles:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-amd64
            trivy_os: linux
            trivy_arch: amd64
            bundle_name: lucidscan-bundle-linux-amd64.tar.gz
            archive_type: tar.gz
          - os: macos-latest
            platform: darwin-arm64
            trivy_os: macos
            trivy_arch: arm64
            bundle_name: lucidscan-bundle-darwin-arm64.tar.gz
            archive_type: tar.gz
          - os: windows-latest
            platform: windows-amd64
            trivy_os: windows
            trivy_arch: amd64
            bundle_name: lucidscan-bundle-windows-amd64.zip
            archive_type: zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Read scanner versions (Unix)
        if: runner.os != 'Windows'
        id: versions-unix
        run: |
          echo "trivy=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['trivy'])")" >> $GITHUB_OUTPUT
          echo "semgrep=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['semgrep'])")" >> $GITHUB_OUTPUT
          echo "checkov=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['checkov'])")" >> $GITHUB_OUTPUT
          echo "lucidscan=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")" >> $GITHUB_OUTPUT

      - name: Read scanner versions (Windows)
        if: runner.os == 'Windows'
        id: versions-windows
        shell: pwsh
        run: |
          $trivy = python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['trivy'])"
          $semgrep = python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['semgrep'])"
          $checkov = python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['checkov'])"
          $lucidscan = python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])"
          "trivy=$trivy" >> $env:GITHUB_OUTPUT
          "semgrep=$semgrep" >> $env:GITHUB_OUTPUT
          "checkov=$checkov" >> $env:GITHUB_OUTPUT
          "lucidscan=$lucidscan" >> $env:GITHUB_OUTPUT

      - name: Set versions output
        id: versions
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            echo "trivy=${{ steps.versions-windows.outputs.trivy }}" >> $GITHUB_OUTPUT
            echo "semgrep=${{ steps.versions-windows.outputs.semgrep }}" >> $GITHUB_OUTPUT
            echo "checkov=${{ steps.versions-windows.outputs.checkov }}" >> $GITHUB_OUTPUT
            echo "lucidscan=${{ steps.versions-windows.outputs.lucidscan }}" >> $GITHUB_OUTPUT
          else
            echo "trivy=${{ steps.versions-unix.outputs.trivy }}" >> $GITHUB_OUTPUT
            echo "semgrep=${{ steps.versions-unix.outputs.semgrep }}" >> $GITHUB_OUTPUT
            echo "checkov=${{ steps.versions-unix.outputs.checkov }}" >> $GITHUB_OUTPUT
            echo "lucidscan=${{ steps.versions-unix.outputs.lucidscan }}" >> $GITHUB_OUTPUT
          fi

      - name: Create bundle directory structure (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist/bundle/bin
          mkdir -p dist/bundle/config

      - name: Create bundle directory structure (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "dist\bundle\bin" -Force
          New-Item -ItemType Directory -Path "dist\bundle\config" -Force

      - name: Create Python virtual environment (Unix)
        if: runner.os != 'Windows'
        run: |
          python -m venv dist/bundle/venv
          dist/bundle/venv/bin/pip install --upgrade pip

      - name: Create Python virtual environment (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m venv dist\bundle\venv
          dist\bundle\venv\Scripts\python.exe -m pip install --upgrade pip

      - name: Install Semgrep (Unix)
        if: runner.os != 'Windows'
        run: |
          dist/bundle/venv/bin/pip install "semgrep==${{ steps.versions.outputs.semgrep }}"

      - name: Install Semgrep (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          dist\bundle\venv\Scripts\pip.exe install "semgrep==${{ steps.versions.outputs.semgrep }}"

      - name: Install Checkov (Unix)
        if: runner.os != 'Windows'
        run: |
          dist/bundle/venv/bin/pip install "checkov==${{ steps.versions.outputs.checkov }}"

      - name: Install Checkov (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          dist\bundle\venv\Scripts\pip.exe install "checkov==${{ steps.versions.outputs.checkov }}"

      - name: Download Trivy (Unix)
        if: runner.os != 'Windows'
        run: |
          curl -sfL "https://get.trivy.dev/trivy?type=tar.gz&version=${{ steps.versions.outputs.trivy }}&os=${{ matrix.trivy_os }}&arch=${{ matrix.trivy_arch }}" | tar xzf - -C dist/bundle/bin
          chmod +x dist/bundle/bin/trivy

      - name: Download Trivy (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $trivyUrl = "https://get.trivy.dev/trivy?type=zip&version=${{ steps.versions.outputs.trivy }}&os=${{ matrix.trivy_os }}&arch=${{ matrix.trivy_arch }}"
          Invoke-WebRequest -Uri $trivyUrl -OutFile "trivy.zip"
          Expand-Archive -Path "trivy.zip" -DestinationPath "dist\bundle\bin" -Force
          Remove-Item "trivy.zip"

      - name: Generate versions.json (Unix)
        if: runner.os != 'Windows'
        run: |
          cat > dist/bundle/config/versions.json <<EOF
          {
            "lucidscan": "${{ steps.versions.outputs.lucidscan }}",
            "trivy": "${{ steps.versions.outputs.trivy }}",
            "semgrep": "${{ steps.versions.outputs.semgrep }}",
            "checkov": "${{ steps.versions.outputs.checkov }}",
            "python": "${{ env.PYTHON_VERSION }}",
            "platform": "${{ matrix.platform }}",
            "bundleVersion": "$(date -u +%Y.%m.%d)"
          }
          EOF

      - name: Generate versions.json (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $versions = @{
            lucidscan = "${{ steps.versions.outputs.lucidscan }}"
            trivy = "${{ steps.versions.outputs.trivy }}"
            semgrep = "${{ steps.versions.outputs.semgrep }}"
            checkov = "${{ steps.versions.outputs.checkov }}"
            python = "${{ env.PYTHON_VERSION }}"
            platform = "${{ matrix.platform }}"
            bundleVersion = (Get-Date -Format "yyyy.MM.dd")
          } | ConvertTo-Json -Depth 10
          Set-Content -Path "dist\bundle\config\versions.json" -Value $versions

      - name: Verify Trivy installation (Unix)
        if: runner.os != 'Windows'
        run: dist/bundle/bin/trivy --version

      - name: Verify Trivy installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: dist\bundle\bin\trivy.exe --version

      - name: Create tar.gz archive (Unix)
        if: matrix.archive_type == 'tar.gz'
        run: |
          cd dist
          tar -czvf ${{ matrix.bundle_name }} -C bundle .

      - name: Create zip archive (Windows)
        if: matrix.archive_type == 'zip'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\bundle\*" -DestinationPath "dist\${{ matrix.bundle_name }}" -Force

      - name: Generate checksum (Unix)
        if: runner.os != 'Windows'
        run: |
          cd dist
          sha256sum ${{ matrix.bundle_name }} > ${{ matrix.bundle_name }}.sha256

      - name: Generate checksum (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $hash = Get-FileHash -Path "dist\${{ matrix.bundle_name }}" -Algorithm SHA256
          "$($hash.Hash.ToLower())  ${{ matrix.bundle_name }}" | Out-File -FilePath "dist\${{ matrix.bundle_name }}.sha256" -Encoding utf8

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.bundle_name }}
          path: dist/${{ matrix.bundle_name }}
          retention-days: 1

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.bundle_name }}.sha256
          path: dist/${{ matrix.bundle_name }}.sha256
          retention-days: 1

  # Build ARM64 Linux bundle using QEMU
  build-linux-arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Read scanner versions
        id: versions
        run: |
          echo "trivy=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['trivy'])")" >> $GITHUB_OUTPUT
          echo "semgrep=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['semgrep'])")" >> $GITHUB_OUTPUT
          echo "checkov=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['checkov'])")" >> $GITHUB_OUTPUT
          echo "lucidscan=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")" >> $GITHUB_OUTPUT

      - name: Build ARM64 bundle in container
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -e TRIVY_VERSION=${{ steps.versions.outputs.trivy }} \
            -e SEMGREP_VERSION=${{ steps.versions.outputs.semgrep }} \
            -e CHECKOV_VERSION=${{ steps.versions.outputs.checkov }} \
            -e LUCIDSCAN_VERSION=${{ steps.versions.outputs.lucidscan }} \
            arm64v8/python:3.11 \
            /bin/bash -c '
              set -e
              cd /workspace

              # Create bundle structure
              mkdir -p dist/bundle/bin dist/bundle/config

              # Create venv and install tools
              python -m venv dist/bundle/venv
              dist/bundle/venv/bin/pip install --upgrade pip
              dist/bundle/venv/bin/pip install "semgrep==${SEMGREP_VERSION}"
              dist/bundle/venv/bin/pip install "checkov==${CHECKOV_VERSION}"

              # Download Trivy
              apt-get update && apt-get install -y curl
              curl -sfL "https://get.trivy.dev/trivy?type=tar.gz&version=${TRIVY_VERSION}&os=linux&arch=arm64" | tar xzf - -C dist/bundle/bin
              chmod +x dist/bundle/bin/trivy

              # Generate versions.json
              cat > dist/bundle/config/versions.json <<EOF
              {
                "lucidscan": "${LUCIDSCAN_VERSION}",
                "trivy": "${TRIVY_VERSION}",
                "semgrep": "${SEMGREP_VERSION}",
                "checkov": "${CHECKOV_VERSION}",
                "python": "3.11",
                "platform": "linux-arm64",
                "bundleVersion": "$(date -u +%Y.%m.%d)"
              }
          EOF

              # Verify
              dist/bundle/bin/trivy --version

              # Create archive
              cd dist
              tar -czvf lucidscan-bundle-linux-arm64.tar.gz -C bundle .
              sha256sum lucidscan-bundle-linux-arm64.tar.gz > lucidscan-bundle-linux-arm64.tar.gz.sha256
            '

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: lucidscan-bundle-linux-arm64.tar.gz
          path: dist/lucidscan-bundle-linux-arm64.tar.gz
          retention-days: 1

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: lucidscan-bundle-linux-arm64.tar.gz.sha256
          path: dist/lucidscan-bundle-linux-arm64.tar.gz.sha256
          retention-days: 1

  # Build and publish Python package to PyPI
  build-python-package:
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/*.whl
          retention-days: 1

      - name: Upload sdist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-sdist
          path: dist/*.tar.gz
          retention-days: 1

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  # Create GitHub Release with all artifacts
  create-release:
    needs: [build-bundles, build-linux-arm64, build-python-package]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Debug - List downloaded artifacts
        run: |
          echo "=== Listing artifacts directory ==="
          ls -laR artifacts/ || echo "artifacts directory not found"

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Move bundle archives
          find artifacts -name "*.tar.gz" -not -name "*.sha256" -not -path "*/python-sdist/*" -exec mv {} release/ \; || true
          find artifacts -name "*.zip" -not -name "*.sha256" -exec mv {} release/ \; || true

          # Move checksums
          find artifacts -name "*.sha256" -exec mv {} release/ \;

          # Combine checksums into single file
          cd release
          cat *.sha256 > SHA256SUMS
          rm -f *.sha256

      - name: Read versions for release notes
        id: versions
        run: |
          echo "trivy=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['trivy'])")" >> $GITHUB_OUTPUT
          echo "semgrep=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['semgrep'])")" >> $GITHUB_OUTPUT
          echo "checkov=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['tool']['lucidscan']['scanners']['checkov'])")" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## Scanner Versions

            | Scanner | Version |
            |---------|---------|
            | Trivy | ${{ steps.versions.outputs.trivy }} |
            | Semgrep | ${{ steps.versions.outputs.semgrep }} |
            | Checkov | ${{ steps.versions.outputs.checkov }} |

            ## Installation

            ```bash
            pip install lucidscan
            ```

            On first run, `lucidscan` will automatically download the appropriate tool bundle for your platform.

            ## Platform Bundles

            | Platform | Bundle |
            |----------|--------|
            | Linux amd64 | `lucidscan-bundle-linux-amd64.tar.gz` |
            | Linux arm64 | `lucidscan-bundle-linux-arm64.tar.gz` |
            | macOS arm64 | `lucidscan-bundle-darwin-arm64.tar.gz` |
            | Windows amd64 | `lucidscan-bundle-windows-amd64.zip` |

            Checksums are available in `SHA256SUMS`.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build and push Docker image
  build-docker:
    needs: [build-bundles]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux amd64 bundle
        uses: actions/download-artifact@v4
        with:
          name: lucidscan-bundle-linux-amd64.tar.gz
          path: docker-build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Dockerfile
        run: |
          cat > docker-build/Dockerfile <<'EOF'
          FROM python:3.11-slim

          # Install lucidscan CLI
          COPY lucidscan-bundle-linux-amd64.tar.gz /tmp/
          RUN mkdir -p /usr/local/lucidscan && \
              tar -xzf /tmp/lucidscan-bundle-linux-amd64.tar.gz -C /usr/local/lucidscan && \
              rm /tmp/lucidscan-bundle-linux-amd64.tar.gz

          # Set environment
          ENV LUCIDSCAN_HOME=/usr/local/lucidscan
          ENV PATH="/usr/local/lucidscan/bin:/usr/local/lucidscan/venv/bin:${PATH}"

          # Pre-warm Trivy DB (optional, increases image size but speeds up first scan)
          RUN trivy image --download-db-only 2>/dev/null || true

          # Install lucidscan CLI package
          RUN pip install --no-cache-dir lucidscan || true

          WORKDIR /workspace
          ENTRYPOINT ["lucidscan"]
          EOF

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: docker-build
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/lucidscan:latest
            ghcr.io/${{ github.repository_owner }}/lucidscan:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
